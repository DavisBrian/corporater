# Relational Data

```{r, message=FALSE}
library(tidyverse)
```


Data analysis rarely involves only a single table of data. Typically you have multiple tables of data, when combined, answer the questions at hand. Collectively, multiple tables of data are called __relational data__ because it is the relations, not just the individual datasets, that are important. Relations are **always** defined between a pair of tables. All other relations are built up from this simple idea.

To work with relational data you need verbs that work with pairs of tables. There are three families of verbs designed to work with relational data:

* __Mutating joins__, which add new variables to one data frame from matching
  observations in another.

* __Filtering joins__, which filter observations from one data frame based on
  whether or not they match an observation in the other table.

* __Set operations__, which treat observations as if they were set elements.

The most common place to find relational data is in a _relational_ database management system (or RDBMS), a term that encompasses almost all modern databases. If you've used a database before, you've almost certainly used SQL. A **key** is a variable, or set of variables, that uniquely identifies an observation.

```{r}
x <- tribble(
  ~key, ~val_x,
     1, "x1",
     2, "x2",
     3, "x3"
)
y <- tribble(
  ~key, ~val_y,
     1, "y1",
     2, "y2",
     4, "y3"
)

x
y
```


## Mutating Joins

A mutating join allows you to combine variables from two tables. It first matches observations by their keys, then copies across variables from one table to the other. Like mutate(), the join functions add variables to the right, so if you have a lot of variables already, the new variables wonâ€™t get printed out.
Inner Joins

*  **inner join** keeps all observations in common between x and y

```{r, echo = FALSE, out.width = NULL}
knitr::include_graphics("images/relational/join-inner.png")
```

```{r}
inner_join(x, y)
```

Outer Joins

*  **left join** keeps all observations in x append columns from y
*  **right join** keeps all observations in y append columns from x
*  **full join** keeps all observations in x and y

```{r, echo = FALSE, out.width = NULL}
knitr::include_graphics("images/relational/join-outer.png")
```

```{r}
left_join(x, y, by = "key")
right_join(x, y, by = "key")
full_join(x, y, by = "key")
```


### Duplicate keys

#### **One-to-Many**
```{r, echo = FALSE, out.width = NULL}
knitr::include_graphics("images/relational/join-one-to-many.png")
```

#### **Many-to-Many**
```{r, echo = FALSE, out.width = NULL}
knitr::include_graphics("images/relational/join-many-to-many.png")
```

### Multiple columns

```{r}
x <- tribble(
  ~id, ~yq, ~question1,
     1, "2018Q1", "Yes",
     1, "2018Q2", "No",
     2, "2018Q1", "Yes",
     3, "2018Q1", "Yes",
     3, "2018Q2", "Yes"
)

y <- tribble(
  ~id, ~yq, ~question2,
     1, "2018Q2", "Method1",
     2, "2018Q1", "Method2",
     2, "2018Q2", "Method2",
     3, "2018Q2", "Method2",
     4, "2018Q1", "Method1"
)

# inner
inner_join(x, y, by = c("id", "yq"))

# left / right
left_join(x, y, by = c("id", "yq"))
right_join(x, y, by = c("id", "yq"))

# left and right are interchangeable
right_join(y, x, by = c("id", "yq"))
left_join(y, x, by = c("id", "yq"))

# full
full_join(x, y, by = c("id", "yq"))
full_join(y, x, by = c("id", "yq"))
```



### Column names don't match
```{r}
x <- tribble(
  ~id, ~yq, ~question1,
     1, "2018Q1", "Yes",
     1, "2018Q2", "No",
     2, "2018Q1", "Yes",
     3, "2018Q1", "Yes",
     3, "2018Q2", "Yes"
)

y <- tribble(
  ~id, ~yearquarter, ~question2,
     1, "2018Q2", "Method1",
     2, "2018Q1", "Method2",
     2, "2018Q2", "Method2",
     3, "2018Q2", "Method2",
     4, "2018Q1", "Method1"
)

# inner
inner_join(x, y, by = c("id", "yq" = "yearquarter"))
```


### Duplicate Columns

```{r}
orig <- tribble(
  ~id, ~yq, ~question,
     1, "2018Q1", "Yes",
     1, "2018Q2", "No",
     2, "2018Q1", "Yes",
     3, "2018Q1", "Yes",
     3, "2018Q2", "Yes"
)

val <- tribble(
  ~id, ~yq, ~question,
     1, "2018Q1", "No",
     1, "2018Q2", "No",
     2, "2018Q1", "Yes",
     3, "2018Q1", "No",
     3, "2018Q2", "Yes"
)

# left
left_join(orig, val, by = c("id", "yq"))
left_join(orig, val, by = c("id", "yq"), suffix = c("_orig", "_val"))
```


## Filtering Joins

*  **semi join** keeps all observations in x that have a match in y
*  **anti join** drops all observations in x that have a match in y

```{r, echo = FALSE, out.width = NULL}
knitr::include_graphics("images/relational/join-semi.png")
```
```{r, echo = FALSE, out.width = NULL}
knitr::include_graphics("images/relational/join-anti.png")
```

```{r}

semi_join(orig, val, by = c("id", "yq", "question"))

anti_join(orig, val, by = c("id", "yq", "question"))
```





## Set Operations
